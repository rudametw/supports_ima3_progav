\RequirePackage[l2tabu, orthodox]{nag}

%\documentclass[a4paper]{article}
%\documentclass[final, pdftex, a4paper, 12pt, openbib, ]{article}
\documentclass[final, pdftex, a4paper, openbib, ]{article}
\usepackage[utf8]{inputenc}
\usepackage[francais]{babel}
%\usepackage{lmodern}
\usepackage[T1]{fontenc}
%\usepackage{graphicx}
\usepackage{alltt}
\usepackage{float}
%\usepackage{times}
%\usepackage{a4wide}
\usepackage{upquote,textcomp}
\usepackage{geometry}
%\usepackage{hyperref}
\usepackage[
pdftex,
final,                      % if you do    want to have clickable-colorful links
pdfstartview = FitV,
linktocpage  = false,       % ToC, LoF, LoT place hyperlink on page number, rather than entry text
breaklinks   = true,        % so long urls are correctly broken across lines
% pagebackref  = false,     % add page number in bibliography and link to position in document where cited
]{hyperref}
\usepackage{mathtools}
\geometry{a4paper, portrait, margin=2cm}
%\addtolength{\textheight}{2 cm}
%\addtolength{\oddsidemargin}{-1cm}
%\addtolength{\topmargin}{-1cm}
%\addtolength{\textwidth}{1 cm}

%Good solution for monospaces
%\usepackage{pxfonts} % Or palatino or mathpazo, changes all fonts to something sans
%\usepackage{eulervm} % only changes math fonts, i checked
%\usepackage[ttdefault=true]{AnonymousPro} %Only changes tt fonts
% WHICH ONE TO CHOOSE?
\usepackage{pslatex}
%\usepackage[ttdefault=true]{AnonymousPro} %Only changes tt fonts
% \usepackage[varg, cmintegrals, cmbraces, ]{newtxtext,newtxmath} % libertine, uprightGreek (U.S.) or slantedGreek (ISO), 
% \usepackage{tgtermes}
% \usepackage{txfonts}
% \usepackage{mathptmx}
% \usepackage[scaled=.90]{helvet}
% \usepackage{courier}
% \usepackage{textcomp}     % required for special glyphs
% \usepackage{bm}   


\usepackage{caption}
\captionsetup[figure]{labelformat=empty}% redefines the caption setup of the figures environment in the beamer class.

%Inconsoloata, a little too light.
%\usepackage{inconsolata}
%\renewcommand{\ttdefault}{Consolas}
%\usepackage{fontspec} %Doesn't work with pdflatex
%\setmonofont{Consolas}



%\renewcommand*\familydefault{\ttdefault} %% Only if the base font of the document is to be typewriter style

%\newcommand\Fontvi{\fontsize{6}{7.2}\selectfont}

%Make tabularx center cells vertically
%\def\tabularxcolumn#1{m{#1}}
%\renewcommand{\tabularxcolumn}[1]{>{\small}m{#1}}

%%Syntax hilighting
%\usepackage{fancyvrb}
\usepackage{minted}
%\usepackage[newfloat]{minted}
\usemintedstyle{borland}
%\usepackage{etoolbox}
%\AtBeginEnvironment{minted}{\singlespacing%
%	\fontsize{14}{14}\selectfont}
%\newminted{java}{fontsize=\footnotesize}
\usepackage{caption}

%\usepackage{multicol}
%\usepackage{vwcol}
%\usepackage{lipsum}
%\usepackage{microtype}
%\setlength{\columnseprule}{0.4pt}
%\renewcommand{\columnseprulecolor}{\color{red}}
\newcommand{\BAD}[1]{{\color{red}#1}}
\newcommand{\GOOD}[1]{{\color{darkgreen}#1}}


\usepackage{graphicx}
\usepackage{colortbl,array}
\usepackage{tabularx}
\definecolor{warningbackground}{RGB}{252,226,158}

\newcommand{\alertwarningbox}[1]{
    \centering
    \begin{tabularx}{0.9\linewidth}{
        >{\columncolor{warningbackground}}c
        >{\columncolor{warningbackground}}X}
        \raisebox{\dimexpr2\baselineskip-\height}
        {\includegraphics[scale=0.8]{attention.pdf}}&
        \raisebox{\tabcolsep}{\strut}#1\raisebox{-\tabcolsep}{\strut}
    \end{tabularx}
}


\usepackage{xcolor}

%\definecolor{infobackground}{RGB}{217,237,247}
%\definecolor{infoforeground}{RGB}{58,135,173}
%\definecolor{infoborder}{RGB}{188,232,241}

\definecolor{infobackground}{RGB}{217,237,247}
\definecolor{infoforeground}{RGB}{30,50,70}
\definecolor{infoborder}{RGB}{30,50,70}

\definecolor{infobackground}{RGB}{217,237,247}
\definecolor{infoforeground}{RGB}{30, 80, 150}
\definecolor{infoborder}{RGB}{47, 87, 232}


\usepackage{environ}
\usepackage{tikz}
\usetikzlibrary{fit,backgrounds,calc}

\NewEnviron{alertinfo}[1]
{
\begin{center}
    \begin{tikzpicture}
    \node[inner sep=0pt,
          draw=infoborder,
          line width=1pt,
          fill=infobackground] (box) {\parbox[t]{0.99\textwidth}
        {%
            \begin{minipage}{.12\textwidth}
                \centering\tikz[scale=3]
                \node[scale=1]
                {
%                    \includegraphics[scale=0.25]{\images/information.pdf}
                    \includegraphics[scale=0.15]{\images/information.pdf}                    
                };
            \end{minipage}%
           \begin{minipage}{.86\textwidth}
%                \vskip 10pt
                \textbf{\textcolor{infoforeground}{\large #1}}\par\smallskip
                \textcolor{infoforeground}{\large \BODY}
                \par\smallskip
                \par\smallskip
            \end{minipage}\hfill
        }%
    };
    \end{tikzpicture}
\end{center}
}

\usepackage{titling}


\newcommand{\codes}{../codes/TP3}
\newcommand{\images}{../images}


%\title{GBIAAL 4$^{\mbox{\`eme}}$ année \\ Devoir Surveillé --- Base de données \\ 13 janvier 2016  \\ 1 heure}
\title{IMA 3$^{\mbox{\`eme}}$ année\\ Programmation Avancé
	%\\TP1 Structures, Listes contiguës, Redirections}
}
\author{\huge \textbf{TP3 Allocation statique vs dynamique -- Réallocation}}
\setlength{\parindent}{0pt}
\pagestyle{empty}
\date{}


\begin{document}
%\vspace{-15cm}
\posttitle{\par\end{center}}
\setlength{\droptitle}{-45pt}
\maketitle
%\thispagestyle{empty}

%\section{Schéma conceptuel}
\vspace{-1.7cm}
\section{Objectifs}

\begin{itemize}
	\item Savoir utiliser les listes contiguës en C.
	\item Savoir allouer un vecteur et une matrice dynamiquement
	\item Savoir utiliser la fonction realloc
\end{itemize}

%\textbf{Contexte et préparation : } Le contexte de ce TP est le même que celui du TP1, à savoir une application de gestion d'annuaire.

\paragraph{Contexte et préparation : } Ce TP n'a pas de pré-requis en terme de code existant. Vous travaillerez dans un nouveau répertoire nommé TP3.


\begin{alertinfo}{}
	\textbf{IMPORTANT :} Ce TP est assez court, assurez-vous que vous comprenez bien pourquoi vos programmes
	fonctionnent (ou pas !).\\ \\
	Pour minimiser les risques de faire planter votre PC, lancez votre programme en utilisant la plus faible priorité possible avec les commandes \texttt{ionice} et \texttt{nice}.\\
	E.g., \texttt{ionice -c3 nice -n19 ./programme}
\end{alertinfo}


\section{Questions du TP \large (à faire impérativement)}

Toutes les questions sont à tester au fur et à mesure (appels dans le main), comme d'habitude !


\subsection{Allocation statique vs dynamique}
\begin{enumerate}
	\item Dans un fichier \texttt{alloc\_statique.c} déclarer une fonction avec une matrice d'entiers \texttt{M} de taille \texttt{SIZE*SIZE} avec \texttt{SIZE} constante (par exemple, égale à 400 pour commencer), et initialiser la matrice tel que \texttt{M[i][j]=i+j}.
	Compiler et tester. Augmenter la constante \texttt{SIZE} et observer les limites de l'allocation sur la pile.
	Noter à quelle taille votre code cesse de fonctionner, et à combien de bytes/kilobytes cela correspond.
	\item Dans le même fichier, déclarer maintenant la matrice \texttt{M} comme variable globale, et tester les limites d'allocation dans la zone de données. Donner les limites.
	\item Dans un fichier \texttt{alloc\_dynamique.c}, déclarer \texttt{(int *v)}, allouer et initialiser un vecteur de \texttt{SIZE} entiers.
	\item Dans le fichier \texttt{alloc\_dynamique.c}, déclarer \texttt{(int **mat)}, allouer et initialiser une matrice de taille \texttt{SIZE*SIZE} : la matrice est un \textit{vecteur de vecteurs}.
	Pour faciliter ces allocations, vous pouvez utiliser un boucle qui alloue un vecteur à chaque itération et l'assigne à la matrice.
	\item Tester les limites d'allocation sur le tas en affichant le total de la taille mémoire allouée la première
	fois que \texttt{malloc} retourne \texttt{NULL}.
	Pour trouver les limites, changer la taille des vecteurs (par exemple, allouez 1 mégaoctet par itération, 10 mégaoctets par itération, 100 mégaoctets par itération, 1 gigaoctet par itération, ...).
	\item Désallouer proprement la matrice. Vérifier qu'il n'y a pas de fuite mémoire avec l'utilitaire \textit{valgrind}\footnote{Regardez la documentation pour apprendre à utiliser valgrind \url{http://valgrind.org/docs/manual/quick-start.html\#quick-start.intro}}.
\end{enumerate}

\pagebreak
\subsection{Realloc \small \textit{(Un exercice de F. Boulier pour GIS)}}
Le programme suivant lit une chaîne de caractères au clavier et l'imprime sur la sortie standard.

\begin{figure}[H] %{1.2\textwidth}
	\centering
	\begin{minipage}[b]{0.29\linewidth}
		%\begin{center}
		%	\centering
		\inputminted[
		%frame=lines,
		%framesep=2.5mm,
		%baselinestretch=0.8,
		%	fontsize=\small,
		linenos,
		tabsize=4,
		breaklines,
		%	xleftmargin=100pt,
		xleftmargin=10pt,		
		numbersep=7pt,		
		%firstline=14,lastline=28
		%bgcolor=light-gray
		]
		{c}{\codes/realloc_chaine.c}
		%	\caption{\texttt{isspace.c}}
		%\end{center}
	\end{minipage}
	\begin{minipage}[b]{0.7\linewidth}
%		\begin{center}
		\begin{center}
			\textbf{Questions}
		\end{center}
%		\end{center}
		\begin{enumerate}
			\item Que fait la fonction \texttt{isspace} (man 3 isspace) ?
			\item Modifier ce programme de façon à stocker les caractères dans un vecteur alloué dynamiquement, au fur et à mesure de la lecture. Attention de veiller à ne pas dépasser les limites du vecteur alloué (ajouter une condition d'arrêt dans le \texttt{TQ}). Attention également à désallouer correctement le vecteur en fin d'exécution.
			\item Consulter la documentation de la fonction \texttt{realloc} (man realloc).
			\item Utiliser la fonction \texttt{realloc} afin de redimensionner la taille du vecteur lorsque les limites sont atteintes (par exemple, lui rajouter 8 caractères), afin de permettre la fin de saisie uniquement sur lecture d'un caractère blanc d'espacement ('\texttt{ }', '\texttt{\textbackslash{}n}', '\texttt{\textbackslash{}t}', \ldots). Veiller à désallouer correctement le vecteur en fin d'exécution. Vérifier avec \textit{valgrind} qu'il n'y a pas de fuite mémoire.
		\end{enumerate}		
	\end{minipage}	
\end{figure}

%%\begin{figure}[!h]
%\begin{figure}[H]	
%	\centering
%	\begin{minipage}[c]{0.85\textwidth}
%		%\begin{center}
%		%	\centering
%		\inputminted[
%		%frame=lines,
%		%framesep=2.5mm,
%		%baselinestretch=0.8,
%		%	fontsize=\small,
%		linenos,
%		tabsize=4,
%		breaklines,
%		%	xleftmargin=100pt,
%		numbersep=7pt,		
%		%firstline=14,lastline=28
%		%bgcolor=light-gray
%		]
%		{c}{\codes/realloc_chaine.c}
%		%	\caption{\texttt{isspace.c}}
%		%\end{center}
%	\end{minipage}
%\end{figure}
%
%\begin{enumerate}
%	\item Que fait la fonction \texttt{isspace} (man 3 isspace) ?
%	\item Modifier ce programme de façon à stocker les caractères dans un vecteur alloué dynamiquement, au fur et à mesure de la lecture. Attention de veiller à ne pas dépasser les limites du vecteur alloué (ajouter une condition d'arrêt dans le \texttt{TQ}). Attention également à désallouer correctement le vecteur en fin d'exécution.
%	\item Consulter la documentation de la fonction \texttt{realloc} (man realloc).
%	\item Utiliser la fonction \texttt{realloc} afin de redimensionner la taille du vecteur lorsque les limites sont atteintes (par exemple, lui rajouter 8 caractères), afin de permettre la fin de saisie uniquement sur lecture d'un caractère blanc d'espacement ('\texttt{ }', '\texttt{\textbackslash{}n}', '\texttt{\textbackslash{}t}', \ldots). Veiller à désallouer correctement le vecteur en fin d'exécution. Vérifier avec \textit{valgrind} qu'il n'y a pas de fuite mémoire.
%\end{enumerate}

\section{Questions s’il vous reste du temps}

\paragraph{Une structure chaine} \textit{(D'après un exercice de F.Boulier pour GIS)}.\\Pour faciliter l'écriture d'algorithmes
de chaînes, et ne plus se préoccuper d'allocation dynamique, nous allons encapsuler les chaînes de
caractère dans une structure, et écrire les fonctions de base pour cette structure.
Dans un nouveau fichier \texttt{chaine.c} :

\begin{enumerate}
	\item Déclarer un nouveau type :
			\begin{minted}[mathescape=true,escapeinside=||,tabsize=4]{c}
typedef struct {
	char * data;
	int alloc;
	int size;
} chaine ;
			\end{minted}	

	Le sens de cette structure est le suivant :
	
	\begin{itemize}
		\item Le champs \texttt{data} contient l'adresse d'une zone de mémoire allouée dynamiquement qui
contient une chaîne de caractères (terminée par \texttt{'\textbackslash{}0'}).
		\item Le champs \texttt{alloc} contient le nombre de char alloués à \texttt{data}.
		\item Le champs \texttt{size} contient la longueur de la chaîne (le \texttt{'\textbackslash{}0'} n'est pas compté)
		\item On a toujours \texttt{size+1 <= alloc}.
	\end{itemize}

	\item Écrire la fonction \texttt{init\_chaine(chaine *)} qui initialise les champs \texttt{alloc} et \texttt{size} à \texttt{0}, et \texttt{data} à \texttt{NULL}.
	\item Écrire la fonction \texttt{clean\_chaine(chaine *)} qui désalloue la mémoire allouée dynamiquement pour la chaîne.
	\item Écrire la fonction \texttt{void print\_chaine(chaine *)} qui imprime (les données de) la chaîne.
	\item Écrire une fonction \texttt{concat\_chaine\_char(chaine * , char)} qui ajoute un caractère à la fin de la chaîne, en redimensionnant le champs \texttt{data} si nécessaire (avec \texttt{realloc}).
	\item Tester ces fonctions de la même façon que précédemment : initialisation, copie des caractères demandés à l'utilisateur, puis impression et enfin désallocation.
	\item Écrire une fonction \texttt{concat\_chaine\_chaine(chaine * , chaine *)} qui ajoute tous les caractères de la deuxième chaîne à la fin du premier, en redimensionnant le champs \texttt{data} si nécessaire (avec \texttt{realloc}).	Testez cette nouvelle fonctionnalité.
	
\end{enumerate}


%\section{Annexes}
%\vspace{-0.5cm}

\end{document}